<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì§ ‰∏ä‰º†Êñá‰ª∂Âà∞ËÆæÂ§á</title>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: #f5f6fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        margin: 0;
    }

    h2 {
        color: #2f3640;
        text-align: center;
        margin-bottom: 20px;
    }

    #fileInput {
        display: none;
    }

    .upload-btn {
        background-color: #4cd137;
        color: white;
        padding: 15px 30px;
        font-size: 16px;
        border: none;
        border-radius: 12px;
        margin-bottom: 20px;
        cursor: pointer;
        width: 80%;
        max-width: 300px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: background 0.2s;
    }

    .upload-btn:hover {
        background-color: #44bd32;
    }

    .file-list {
        width: 100%;
        max-width: 400px;
    }

    .file-item {
        background: white;
        padding: 10px;
        margin-bottom: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .file-name {
        font-size: 14px;
        margin-bottom: 6px;
        color: #2f3640;
        word-break: break-all;
    }

    progress {
        width: 100%;
        height: 16px;
        border-radius: 8px;
        overflow: hidden;
        appearance: none;
    }

    progress::-webkit-progress-bar {
        background-color: #dcdde1;
    }

    progress::-webkit-progress-value {
        background-color: #4cd137;
    }

    /* Toast Ê†∑Âºè */
    .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 9999;
        font-size: 14px;
        animation: fadein 0.3s, fadeout 0.5s 1.5s;
    }
    @keyframes fadein { from {opacity: 0;} to {opacity: 1;} }
    @keyframes fadeout { from {opacity: 1;} to {opacity: 0;} }
</style>
</head>
<body>

<h2>üì§ ‰∏ä‰º†Êñá‰ª∂Âà∞ËÆæÂ§á</h2>

<label class="upload-btn" for="fileInput">ÈÄâÊã©Êñá‰ª∂</label>
<input type="file" id="fileInput" multiple />

<div class="file-list" id="fileList"></div>

<script>
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB

// ‰ªé URL ‰∏≠Ëé∑Âèñ token
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get("token");

if (!token) {
    alert("‚ùå URL ‰∏≠Áº∫Â∞ë tokenÔºåÊó†Ê≥ï‰∏ä‰º†ÔºÅ");
}

// toast ÊèêÁ§∫
function showToast(msg) {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.innerText = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// ‰∏ä‰º†Âçï‰∏™Êñá‰ª∂
async function uploadFile(file, progressEl) {
    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

    for (let i = 0; i < totalChunks; i++) {
        const chunk = file.slice(i * CHUNK_SIZE, (i+1) * CHUNK_SIZE);

        const params = new URLSearchParams({
            filename: file.name,
            chunk_index: i,
            total_chunks: totalChunks,
            token: token
        });

        await fetch("/upload?" + params.toString(), { method: "POST", body: chunk });

        progressEl.value = ((i+1)/totalChunks*100);
    }
    showToast(`‚úÖ ${file.name} ‰∏ä‰º†ÂÆåÊàê`);
}

// Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
document.getElementById("fileInput").addEventListener("change", async e => {
    const files = e.target.files;
    const fileListEl = document.getElementById("fileList");
    fileListEl.innerHTML = "";

    for (let file of files) {
        // ËÆ°ÁÆóÂ§ßÂ∞è
        let sizeStr = file.size < 1024*1024 
            ? `${(file.size/1024).toFixed(1)} KB`
            : `${(file.size/1024/1024).toFixed(2)} MB`;

        // ÂàõÂª∫Êñá‰ª∂È°π
        const item = document.createElement("div");
        item.className = "file-item";
        item.innerHTML = `
            <div class="file-name">üìÑ ${file.name} (${sizeStr})</div>
            <progress value="0" max="100"></progress>
        `;
        fileListEl.appendChild(item);

        const progressEl = item.querySelector("progress");
        uploadFile(file, progressEl);
    }
});
</script>

</body>
</html>
